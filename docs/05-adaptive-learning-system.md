# Глава 5: Адаптивная система обучения ("Dynamic Flow")

Этот документ описывает концептуальный и технический дизайн системы **"Dynamic Flow"** — интеллектуального ядра FlowTyping, отвечающего за адаптивное управление сложностью уроков.

## 5.1. Концепция: Обучение в "Зоне Потока"

Система "Dynamic Flow" работает как интеллектуальный "термостат", цель которого — постоянно удерживать пользователя в **"зоне потока" (Flow Zone)**. Это психологическое состояние, когда задача достаточно сложна, чтобы быть интересной и развивающей, но не настолько трудна, чтобы вызывать фрустрацию и демотивацию.

Система постоянно анализирует производительность пользователя и корректирует сложность упражнений в реальном времени:

*   **Слишком легко?** → Пользователь входит в "Зону Скуки". Система плавно **повышает** сложность.
*   **Слишком сложно?** → Пользователь попадает в "Зону Фрустрации". Система **понижает** сложность.
*   **В самый раз?** → Пользователь находится в "Зоне Потока". Система предлагает упражнения того же уровня сложности для **закрепления** навыка.

## 5.2. Ключевые метрики для анализа

Для принятия решений система опирается на набор метрик, которые комплексно оценивают производительность пользователя.

### Категория 1: Базовые метрики (Скорость и Точность)

*   **`cpm` (Characters Per Minute):** Число символов в минуту. Самый точный показатель сырой скорости.
*   **`wpm` (Words Per Minute):** Стандартизированная скорость (`CPM / 5`). Используется как общепринятый мотивационный показатель.
*   **`accuracy` (Точность):** Процент правильных нажатий с первой попытки. **Ключевая метрика**, имеющая наивысший приоритет в алгоритме.

### Категория 2: Метрики качества "Потока"

*   **`rhythmScore` (Стабильность ритма):** Стандартное отклонение времени между нажатиями. Низкое значение указывает на плавный, автоматизированный набор (состояние потока). Высокое значение — на "спотыкания" и поиск клавиш.
*   **`errorCorrectionTime` (Время исправления ошибки):** Среднее время от совершения ошибки до ее исправления. Показывает, насколько быстро пользователь осознает ошибку и реагирует на нее.

### Категория 3: Глубокие диагностические метрики

Это ядро для интеллектуального подбора упражнений.

*   **`confusionMatrix` (Матрица ошибок):** Таблица, показывающая, какие символы пользователь систематически путает (например, нажимает 'd' вместо 's'). Позволяет целенаправленно тренировать проблемные пары.
*   **`perFingerStats` / `perKeyStats` (Производительность по пальцам/клавишам):** Агрегированная статистика (скорость, ошибки) для каждого пальца и клавиши. Выявляет "слабые" пальцы.
*   **`nGramStats` (Производительность N-грамм):** Анализ скорости и точности для частотных сочетаний из 2 (биграммы) или 3 (триграммы) символов. Выявляет проблемные *движения* и *переходы* между пальцами.

### Категория 4: Агрегированная мета-метрика

*   **`performanceScore` (Показатель Производительности):**
    *   **Описание:** Главная интегральная оценка, отражающая текущее состояние пользователя ("в потоке", "скука", "фрустрация"). Рассчитывается на коротком временном отрезке (например, последние 5-10 слов).
    *   **Концептуальная формула:** `PS = (w_acc * Accuracy) + (w_rhythm / RhythmScore) + (w_cpm * CPM_normalized)`
    *   **Применение:** Является главным "сигналом" для системы. На основе значения `Performance Score` система принимает решение о повышении, понижении или сохранении текущего уровня сложности.

## 5.3. Архитектурные компоненты системы

1.  **`Performance Score` (PS):** Вычисляемый в реальном времени показатель производительности, как описано выше. Является главным драйвером для изменения сложности.
2.  **`Difficulty Vector` (DV):** Многомерный объект, описывающий сложность задания (например, `{ complexity: float, length: int, focus: string[] }`), а не простое число. `focus` может содержать проблемные n-граммы или символы.
3.  **Генератор Уроков (`Lesson Generator`):** Компонент, который на основе текущего `Difficulty Vector` подбирает или генерирует подходящий текст (упражнение) из корпуса текстов.
4.  **Корпус Текстов (`Verses Corpus`):** База данных упражнений (фраз, предложений), каждое из которых имеет предварительно рассчитанные характеристики (сложность, длина, частотность символов и т.д.).

## 5.4. Стратегия технической реализации

Реализация системы "Dynamic Flow" будет проходить в несколько итераций.

### Этап 1: Frontend-Only (Рекомендовано для MVP)

Вся логика, база упражнений и статистика пользователя живут в браузере.

*   **Стек:** `localStorage` или `IndexedDB` для хранения корпуса текстов и статистики, `XState` (`training.machine`) для оркестрации цикла "ввод → анализ → коррекция сложности → подбор контента".
*   **Преимущества:** Полностью автономно, работает оффлайн, нулевые затраты на сервер. Идеально для быстрой проверки гипотез.
*   **Недостатки:** Отсутствие синхронизации между устройствами, потенциально долгая первая загрузка.

### Этап 2: Гибридный Local-First (Рекомендовано для Production)

Сочетание скорости локальной работы и мощи бэкенда.

*   **Стек:**
    *   **Клиент:** `IndexedDB` для кэширования "порций" упражнений, `XState` для логики.
    *   **Бэкенд:** Node.js сервер с полноценной БД (например, PostgreSQL) для хранения основного корпуса текстов и профилей пользователей.
    *   **Связь:** API для фоновой синхронизации статистики и подгрузки новых порций упражнений по мере необходимости.
*   **Преимущества:** Мгновенная загрузка, работа в оффлайне, "бесконечный" корпус упражнений и кросс-девайсная синхронизация.

Переход от первого этапа ко второму должен быть спланирован заранее путем инкапсуляции всей логики работы с данными в абстрактный "Репозиторий", который в будущем можно будет легко "переключить" с `localStorage` на API-клиент.
